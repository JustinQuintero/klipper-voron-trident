[gcode_macro LOAD_FILAMENT]
description: Load filament (heat nozzle if necessary)
gcode:
    {% set TEMP = params.TEMP|default(245)|float %}
    {% set DISTANCE = params.DISTANCE|default(40)|float %}
    {% set PURGE = params.PURGE|default(15)|float %}

    M117 Loading filament...
    {% if printer[printer.toolhead.extruder].temperature < TEMP %}
        STATUS_HEATING
        M117 Heating hotend...
        SET_HEATER_TEMPERATURE HEATER='extruder' TARGET={TEMP}
        TEMPERATURE_WAIT SENSOR='extruder' MINIMUM={TEMP}
    {%endif%}

    STATUS_BUSY
    M117 Loading filament...
    M83                                                 # set extruder to relative
    G1 E{DISTANCE|float} F300                           # slower extrusion for hotend path
    G1 E{PURGE|float} F150                              # prime nozzle with filament
    M82                                                 # set extruder to absolute
    UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=10
    STATUS_READY