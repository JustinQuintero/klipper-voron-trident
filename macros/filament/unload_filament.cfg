[gcode_macro UNLOAD_FILAMENT]
description: Heat the nozzle (if needed), then retract the filament out of the toolhead
gcode:
    {% set TEMP = params.TEMP|default(245)|float %}
    {% set DISTANCE = params.DISTANCE|default(80)|float %}

    MAINTENANCE
    {% if printer[printer.toolhead.extruder].temperature < TEMP %}
        STATUS_HEATING
        M117 Heating hotend...
        SET_HEATER_TEMPERATURE HEATER='extruder' TARGET={TEMP}
        TEMPERATURE_WAIT SENSOR='extruder' MINIMUM={TEMP}
    {% endif %}
    STATUS_BUSY
    M117 Unloading filament...
    M83                                                 # set extruder to relative
    G1 E2 F300                                          # extrude a little to soften tip
    G1 E{DISTANCE|float * -1} F1800                     # retract filament completely
    M82                                                 # set extruder to absolute
    UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=10
    STATUS_READY